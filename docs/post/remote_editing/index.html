<!DOCTYPE html>
<html>

<head>
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="description" content="Federico Simonetta is musician and computer engineer. From Pavia to Milan through Padua. Here you found my publications, music, software and contacts. Pop in to know me!">
<title>
Developing and testing on a remote host - Federico Simonetta
</title>


<link rel="shortcut icon" href="https://00sapo.github.io/public/img/avatar.ico">








<link rel="stylesheet" href="https://00sapo.github.io/public/css/main.min.202eb2a494b9f8d0a0b154015fe6c213c3d44bdf745bece33482defd57380131.css" integrity="sha256-IC6ypJS5&#43;NCgsVQBX&#43;bCE8PUS990W&#43;zjNILe/Vc4ATE=" crossorigin="anonymous" media="screen">



<link rel="stylesheet" href="https://00sapo.github.io/public/css/custom.css">


<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic">

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://00sapo.github.io/img/image.jpg"/>

<meta name="twitter:title" content="Developing and testing on a remote host"/>
<meta name="twitter:description" content="Workflow In this document, you can find an introduction to tools commonly used for remote editing and development. The generla workflow is the following:
 You create and edit code on your local machine An indipendent software mirrors your code to the host (syncthing in this document) You interface with the host through terminal, give commands and run code (tmux) Finally, you debug your code (debug section), and edit it your local machine  This workflow allows you to:"/>

<meta property="og:title" content="Developing and testing on a remote host" />
<meta property="og:description" content="Workflow In this document, you can find an introduction to tools commonly used for remote editing and development. The generla workflow is the following:
 You create and edit code on your local machine An indipendent software mirrors your code to the host (syncthing in this document) You interface with the host through terminal, give commands and run code (tmux) Finally, you debug your code (debug section), and edit it your local machine  This workflow allows you to:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://00sapo.github.io/public/post/remote_editing/" /><meta property="og:image" content="https://00sapo.github.io/img/image.jpg"/><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-02-11T11:50:35+00:00" />
<meta property="article:modified_time" content="2020-02-11T11:50:35+00:00" /><meta property="og:site_name" content="Federico Simonetta" />



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-142387081-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "",
  "headline": "Developing and testing on a remote host",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https:\/\/00sapo.github.io\/public\/post\/remote_editing\/"
  },
  "image": {
    "@type": "ImageObject",
    "url": "https:\/\/00sapo.github.io\/img\/avatar.png",
    "width":  1075 ,
    "height":  531 
  },
  "genre": "post",
  "keywords": "software, teaching, remote, cloud, syncthing, tmux",
  "wordcount":  2011 ,
  "url": "https:\/\/00sapo.github.io\/public\/post\/remote_editing\/",
  "datePublished": "2020-02-11T11:50:35\u002b00:00",
  "dateModified": "2020-02-11T11:50:35\u002b00:00",
  "license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.",
  "publisher": {
    "@type": "Organization",
    "name": "Federico Simonetta",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/00sapo.github.io\/img\/avatar.ico",
      "width":  128 ,
      "height":  128 
    }
  },
  "author": {
    "@type": "Person",
    "name": "Federico Simonetta"
  },
  "description": ""
}
</script>


<link rel="canonical" href="https://00sapo.github.io/public/post/remote_editing/">


<script src="https://hypothes.is/embed.js" async></script>


    

    
    
    
    <title>
        
        Developing and testing on a remote host
        
    </title>
</head>

<body>
    <div class="wrap">
        
        <div class="section top-menu">
<p>
    

    
        
            <a href="https://00sapo.github.io/public/post">
                random posts
            </a>
        
    
        
            
                &#183; 
                <a href="https://00sapo.github.io/public/publications">
                    publications
                </a>
            
                &#183; 
                <a href="https://00sapo.github.io/public/software">
                    unsoftware
                </a>
            
                &#183; 
                <a href="https://00sapo.github.io/public/links">
                    not so random links
                </a>
            
                &#183; 
                <a href="https://00sapo.github.io/public/about">
                    who am I?
                </a>
            
                &#183; 
                <a href="https://00sapo.github.io/public/music">
                    noisy stuffs
                </a>
            
                &#183; 
                <a href="https://00sapo.github.io/public/teaching">
                    don&#39;t tell this anyone...
                </a>
            
                &#183; 
                <a href="https://00sapo.github.io/public/notes/allnotes">
                    ...tell everyone this one
                </a>
            
        
        <p>
            <a href="https://00sapo.github.io/public">
                home
            </a>
        </p>
    
</p>
<hr />

</div>
        
    
        <h1 class="section" id="title">Developing and testing on a remote host</h1>

        <div class="section" id="content"><p><img src="//www.dalet.com/uploads/2020/11/Remote-Editing-min1_0.png" alt="banner"></p>
<h2 id="workflow">Workflow</h2>
<p>In this document, you can find an introduction to tools commonly used for remote editing and development. The generla workflow is the following:</p>
<ol>
<li>You create and edit code on your local machine</li>
<li>An indipendent software mirrors your code to the host (<code>syncthing</code> in this document)</li>
<li>You interface with the host through terminal, give commands and run code (<code>tmux</code>)</li>
<li>Finally, you debug your code (<code>debug</code> section), and edit it your local machine</li>
</ol>
<p>This workflow allows you to:</p>
<ol>
<li>use your preferred software for editing</li>
<li>use very low connections (if you are in train or in the smurfs house, for instance)</li>
<li>use any language on the host</li>
<li>run intensive tasks for many many days without interrupting your connection</li>
<li>have the resources on the host machine always at hand</li>
</ol>
<h2 id="basic-set-up">Basic set up</h2>
<p>Create a <code>.ssh</code> folder in your home if it doesn&rsquo;t exist and put in it a file called <code>config</code> with the following content:</p>
<pre tabindex="0"><code>Host *
ControlMaster auto
ControlPath ~/.ssh/sockets/%r@%h-%p
ControlPersist 60

Host amadeus.lim.di.unimi.it !exec &#34;[ -e ~/.ssh/socket-%r@%h:%p ]&#34;
LocalForward 22001 localhost:22000 
RemoteForward 22001 localhost:22000 
LocalForward 8384 localhost:8384 
LocalForward 8097 localhost:8097
LocalForward 6006 localhost:6006
</code></pre><p>This configuration allows the reuse of the first connection among several <code>ssh</code>
commands: if you connect through ssh to any host, all the folloqing <code>ssh</code>
commands will use the first connection: you won&rsquo;t need to retype your password,
the overhead decreases and firewalls will not push you back because of the
proliferating of the number of connections. It also instructs <code>ssh</code> command about the
file to be used as socket.</p>
<p>Moreover, we set ssh to always forward certain ports for the server <code>amadeus.lim.di.unimi.it</code>.
For instance, port 8097 is the one used by <code>visdom</code> for plotting from PyTorch and numpy,
ports 6006, 22001 and 22000 are used by Syncthing for syncing over ssh.</p>
<h2 id="syncing-with-syncthing">Syncing with <code>syncthing</code></h2>
<p><code>syncthing</code> is an open source p2p syncing tool much more powerful than simple SFTP clients. However it must be configured on both sides.</p>
<ol>
<li>Download and install <code>syncthing</code> on both client and host (amadeus has it, but you can still download the pre-compiled binaries in your home if you do not have)</li>
<li>Start syncthing on the client and go to <code>localhost:8384</code> or to the displayed address</li>
<li>Look into <code>Actions &gt; Show ID</code> for the client device ID</li>
<li>Connect via ssh tunneling to the host <code>ssh user@host -L 8385:localhost:8384</code></li>
<li>Start syncthing on the host and go to <code>localhost:8485</code> from the client browser to access syncthing host</li>
<li>Look into <code>Actions &gt; Show ID</code> for the host device ID</li>
<li>On both client and host add a remote device (on host with the client ID and on client with host ID)</li>
<li>Add a new folder and share it with the host</li>
<li>Add ignore patterns (e.g. <code>.git</code> )</li>
<li>Set folder type to <code>send only</code></li>
<li>Check that <code>watch for changes</code> is selected</li>
<li>Repeat points 8-11 on host</li>
<li>On client, click on up-right <code>Actions &gt; Advanced &gt; [synced folder name] &gt; Fs Watcher Delay</code> and set to 1 (the minimum allowed, 1 second)</li>
</ol>
<p>Save the configuration and restart.</p>
<p>If one of your machines is behind a strict firewall, it can be useful to use ssh tunneling for connecting.
This requires a particular configuration that you first connect to the remote machine through ssh with port forwarding and then start syncthing on both machines.
See the <code>.ssh/config</code> file in previous paragraph. More info in the <a href="https://docs.syncthing.net/users/tunneling.html">official guides</a>.</p>
<h2 id="running-tmux">Running tmux</h2>
<p>Once you have synced code, you should connect through ssh to the remote host and start <code>tmux</code> to run your code. <code>tmux</code> is a nice piece of software used for working on remote host. It can be used to run long experiments that need to disconnect your machine (e.g. experiments lasting many days). I really recommend to always use tmux. Using it, you can also use the same terminal creating multiple tabs and split. One recurring pattern, for instance, is having the terminal with 3 splits: one for the experiment running, the second for controlling the resources on the remote machine and the third to give commands to the machine.</p>
<p>For controlling <code>tmux</code> you need to prepend each command with <code>CTRL-b</code>: everything pressed after this combination will be interpreted as a tmux command and it will not be written to the terminal.
These steps exemplify the use of <code>tmux</code>:</p>
<ol>
<li>Connect to the remote host with <code>ssh username@host</code></li>
<li>Run <code>tmux</code>. Now, a new blank terminal is shown. Notice the bottom bar indicating some useful information</li>
<li>Press in sequence <code>CTRL-b</code> and <code>%</code>. Now the window is splitted.</li>
<li>Try <code>CTRL-b</code> and <code>&quot;</code>.</li>
<li>With <code>CTRL-b</code> and <code>x</code> you can kill the splits (and all the precesses running from it). The same with the command <code>exit</code></li>
<li>With <code>CTRL-b</code> and arrow you can move to an existing split</li>
<li>With <code>CTRL-b</code> and <code>c</code> you can create a new tab</li>
<li>With <code>CTRL-b</code> and <code>[</code> you enter to &ldquo;copy mode&rdquo;: in this modality you can go up and down in the terminal and you can select and copy its content. Try surfing with arrows and <code>PgUp</code> and <code>PgDown</code> keys.</li>
<li>Press <code>CTRL+SPACE</code> to start copying</li>
<li>Press <code>ALT-w</code> or <code>CTRL-w</code> to copy the selection</li>
<li>Press <code>q</code> to exit the copy mode</li>
<li>Press <code>CTRL+b</code> and <code>]</code> to paste</li>
<li>Try <code>CTRL+b</code> and <code>d</code>. The tmux session will be detached</li>
<li>Exit from the ssh connection and reconnect</li>
<li>Use <code>tmux a</code> to reattach to the previous session, that is continued to exist</li>
</ol>
<p>Since key <code>CTRL-b</code> is not that comfortable, I suggest to change it: create a file in your home called <code>.tmux.conf</code> and put the following lines:</p>
<pre tabindex="0"><code>unbind-key C-b
set -g prefix `
bind-key ` send-prefix
</code></pre><p>Now instead of pressing <code>CTRL-b</code>, you can just press ` char (for italian keyboard, you could use the <code>\</code> char, for instance).</p>
<p>You can also customize your keybindings to make them more easy to remember. For instance, I use keybindings very similar to <code>vim</code>. For more info see <a href="https://tmuxcheatsheet.com/">https://tmuxcheatsheet.com/</a>.</p>
<p><strong>N.B. If the terminal become unresponsive, it can be that the ssh connection has been closed server-side (e.g. because of a connection error). In such a case, press <code>~</code> and then <code>.</code> to close the connection and return to your local terminal. If it doesn&rsquo;t work, see the &ldquo;SOS&rdquo; section.</strong></p>
<h2 id="controlling-resources">Controlling resources</h2>
<p>It is a good practice to continuously monitor the resources on the host in a separate split.</p>
<p>For CPU and RAM, just run <code>htop</code> command in a seprate always live split.
For GPU, run <code>watch -n 5 nvidia-smi</code>. The <code>watch</code> command will repeatedly run the <code>nvidia-smi</code> command every 5 seconds.
With these two commands you should be able to understand if:</p>
<ol>
<li>you are using too many resources (please, stop your program before the machine RAM is full, otherwise see &ldquo;SOS&rdquo; section)</li>
<li>you are using too few ersources (for instance if GPU is not used or no parallel processing is in action)</li>
<li>you are using wrong resources (too many parallel processes, wrong GPU, etc.)</li>
</ol>
<p>Note that in <code>pytorch</code> you should use internal commands <code>torch.cuda.memory_allocated</code> and <code>torch.cuda.max_memory_allocated</code> since <code>nvidia-smi</code> fails in showing the real amount of RAM used: <a href="https://pytorch.org/docs/stable/notes/cuda.html#memory-management">docs</a></p>
<h2 id="debugging-code">Debugging code</h2>
<p>For debugging code from remote you need to use a debugger. I suggest to always debug your code without parallelism whenever possible.</p>
<h3 id="python">Python</h3>
<p>In Python, just use the default debugger. Since version 3.7 you can simply add the instruction <code>debugger()</code> one line before the one you want to start the debug. You can set up your preferred debugger (I suggest <code>ipdb</code>). For previous versions use <code>import pdb; pdb.set_trace()</code>.</p>
<p>A better debugger is ipdb (<code>import ipdb; ipdb.set_trace()</code>). You will probably need to install it: <code>pip install ipdb</code>. See its commands by pressing <code>h</code> or <a href="http://wangchuan.github.io/coding/2017/07/12/ipdb-cheat-sheet.html">here</a></p>
<p>If you really want a graphical debugger, you try <a href="https://github.com/Kozea/wdb">wdb</a>. You will probably need to install it: <code>pip install wdb</code>.</p>
<p>Another useful tool is <a href="https://github.com/cool-RR/PySnooper">pysnooper</a>. You can use it in place of printing to stdout or of logging. It&rsquo;s much easier to use and very powerful. I use it for debugging scripts with multiprocessing on different files.</p>
<p>I also recommend to use <code>pyenv</code> and <code>poetry</code> to isolate your project from the OS python packages.</p>
<h3 id="matlab">Matlab</h3>
<p>In <code>matlab</code>, you can use the default debugger by using the statement <code>keyboard</code> just one line after you want to stop. Then you will be prompted and you can use typical matlab commands to show variables. However, the editing needs the use a <code>emacs</code> keys (as of now I am still not able to change these mappings). Remember these ones:</p>
<table>
<thead>
<tr>
<th>KEY</th>
<th>ACTION</th>
</tr>
</thead>
<tbody>
<tr>
<td>CTRL-a</td>
<td>move cursor to (at) beginning-of-line</td>
</tr>
<tr>
<td>CTRL-e</td>
<td>move cursor to end-of-line</td>
</tr>
<tr>
<td>CTRL-f</td>
<td>move cursor forward one character</td>
</tr>
<tr>
<td>CTRL-b*</td>
<td>move cursor backward one character</td>
</tr>
</tbody>
</table>
<p>* <em>if you are using the default tmux keymap, <code>CTRL_B</code> is also the tmux escape sequence; in this case you&rsquo;ll have to press twice <code>CTRL-B</code> to send it to Matlab</em></p>
<p>For managing the debugging itself, you can use <a href="https://www.mathworks.com/help/matlab/ref/dbcont.html">dbcont</a>, <a href="https://www.mathworks.com/help/matlab/ref/dbstep.html">dbstep</a>, <a href="https://www.mathworks.com/help/matlab/ref/dbquit.html">dbquit</a> and all the commands listed in the <a href="https://www.mathworks.com/help/matlab/debugging-code.html">official docs</a></p>
<h3 id="julia">Julia</h3>
<p>Use <a href="https://github.com/JuliaDebug/Debugger.jl">Debugger</a> package: command <code>]add Debugger</code> from Julia REPL.
Set breakpoints with <code>@bp</code>. Start debugging a function with <code>@enter functionName(args)</code> (will stop at the first instruction) or with <code>@run functionName(args)</code> (will stop at the first breakpoint).</p>
<p>Open the REPL. Run <code>include('filename'); mainFunction()</code> to test mainFunction after having edited it. Alternatively, you can also try <a href="https://github.com/timholy/Revise.jl">Revise</a> to automatically reload changed modules.</p>
<h2 id="sos">SOS</h2>
<p>It can happen that your program fill the host resources. In that case, you can:</p>
<ol>
<li>try to kill the program from inside the <code>ssh</code> connection keeping pressed <code>CTRL-C</code></li>
<li>if <code>1.</code> doesn&rsquo;t work, create a new terminal or a new split in tmux and run <code>kill PROCESS NUMBER</code> (you can find the process number with <code>ps x</code> or <code>htop</code>)</li>
<li>if neither <code>2.</code> works for your, try killing the termux split with <code>CTRL-b</code> and <code>x</code></li>
<li>if your ssh connection is completely saturated or the host doesn&rsquo;t answer, then from another local terminal run <code>ssh username@host killall program</code> where <code>program</code> is the command of the experiment that your were executing (i.e. <code>python</code>, <code>python3</code>, <code>matlab</code>, etc.). This command will try to create a new ssh connection, run the command <code>killall program</code> and then exit suddenly.</li>
<li>If the machine is not responding contact the administrator as soon as possible</li>
</ol>
<h2 id="bonus">Bonus</h2>
<h3 id="using-linux-containers">Using Linux containers</h3>
<p>I always suggest to use linux containers to isolate your environment and use any software you need. You can think to linux containers as
a different Linux machines running inside the OS - similarly to virtual machines, but they need much fewer resources.</p>
<p>First of all, you need <code>lxc</code> and <code>lxd</code> commands on the host and your user should be in the <code>lxd</code> group. Ask the administrator for this.
All <code>lxc</code> and <code>lxd</code> commands are executed from the parent environment, while inside your container you can work as in a real OS on which you have all admin privileges.</p>
<ol>
<li>Run <code>lxd init</code> to set up your configuration (just use the default options if you are unsure)</li>
<li>Create a new container based on your preferred distro: <code>lxc launch ubuntu:18.04 myubuntu</code>. You can also use other distro and versions, see <a href="images.linuxcontainers.org">the complete list</a></li>
<li>Enter your container by executing a shell <code>lxc exec myubuntu -- /bin/sh</code></li>
<li>Create your user if you want with <code>useradd -m -G sudo,wheel username</code></li>
<li><code>exit</code></li>
<li>Enter to your new user <code>lxc exec myubuntu -- su username</code></li>
<li>Install everything you need</li>
<li>Push/pull files to/from the container: <code>lxc file pull myubuntu/absolute/path .</code></li>
<li>Save your container to file:</li>
</ol>
<pre tabindex="0"><code>lxc publish myubuntu --alias myubuntu_saved
lxc image export myubuntu_saved .
</code></pre><ol start="10">
<li>Reload your container in another machine:</li>
</ol>
<pre tabindex="0"><code>lxc image import image.tar --alias myubuntu_saved
lxc init myubuntu_saved myubuntu
</code></pre><ol start="11">
<li>
<p>Stop it: <code>lxc stop myubuntu</code></p>
</li>
<li>
<p>To use syncthing, you have to forward your host port to the container&rsquo;s one:</p>
<p>lxc config device add mycontainer syncthing8384 proxy listen=tcp:0.0.0.0:8384 connect=tcp:127.0.0.1:8384</p>
</li>
</ol>
<h3 id="using-poetry">Using Poetry</h3>
<p><em>poetry</em> is slowly becoming <em>the</em> python package management system. You can use it to develop packages and to keep you environment isolated and update. It&rsquo;st best to use it in conjunction with <em>pyenv</em>.</p>
<p>For scientific research, I suggest to always set the python version to only one precise version; this will make dependency solving much faster. Also,  suggest to use as environment path a <code>.venv</code> directory in your wirking dir; in this way, you can just distribute the ipped directory to make your research easily reproducible.</p>
<p>[TBC]</p>
</div>

        <div class="section footer"><hr />
<em>Fluid thoughts against categories</em>
</div>
    </div>
</body>

</html>
